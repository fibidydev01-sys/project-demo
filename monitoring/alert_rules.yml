# ===== FILE: monitoring/alert_rules.yml =====
groups:
  # ============================================================================
  # API Performance Alerts
  # ============================================================================
  - name: api_performance
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status_code=~"5.."}[5m])) 
          / sum(rate(http_requests_total[5m])) * 100 > 5
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: 'High API error rate detected'
          description: 'Error rate is {{ $value }}% (threshold: 5%)'

      - alert: SlowResponseTime
        expr: |
          histogram_quantile(0.95, 
            rate(http_request_duration_seconds_bucket[5m])
          ) * 1000 > 2000
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: 'Slow API response time'
          description: 'P95 latency is {{ $value }}ms (threshold: 2000ms)'

      - alert: VerySlowResponseTime
        expr: |
          histogram_quantile(0.95, 
            rate(http_request_duration_seconds_bucket[5m])
          ) * 1000 > 5000
        for: 3m
        labels:
          severity: critical
          component: api
        annotations:
          summary: 'Very slow API response time'
          description: 'P95 latency is {{ $value }}ms (threshold: 5000ms)'

  # ============================================================================
  # Database Performance Alerts
  # ============================================================================
  - name: database_performance
    interval: 30s
    rules:
      - alert: HighDatabaseQueryTime
        expr: |
          histogram_quantile(0.95, 
            rate(db_query_duration_seconds_bucket[5m])
          ) * 1000 > 1000
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: 'High database query time'
          description: 'P95 query time is {{ $value }}ms (threshold: 1000ms)'

      - alert: TooManySlowQueries
        expr: sum(rate(db_slow_queries_total[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: 'Too many slow queries'
          description: '{{ $value }} slow queries/sec detected'

      - alert: DatabaseConnectionPoolExhausted
        expr: db_active_connections > 15
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: 'Database connection pool near exhaustion'
          description: 'Active connections: {{ $value }} (max: ~20)'

      - alert: HighDatabaseErrorRate
        expr: sum(rate(db_errors_total[5m])) > 0.1
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: 'High database error rate'
          description: '{{ $value }} errors/sec detected'

  # ============================================================================
  # Cache Performance Alerts
  # ============================================================================
  - name: cache_performance
    interval: 30s
    rules:
      - alert: LowCacheHitRate
        expr: |
          sum(rate(cache_hits_total[5m])) 
          / (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m]))) 
          * 100 < 70
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: 'Low cache hit rate'
          description: 'Cache hit rate is {{ $value }}% (threshold: 70%)'

      - alert: VeryLowCacheHitRate
        expr: |
          sum(rate(cache_hits_total[5m])) 
          / (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m]))) 
          * 100 < 50
        for: 5m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: 'Very low cache hit rate'
          description: 'Cache hit rate is {{ $value }}% (threshold: 50%)'

      - alert: HighCacheMemoryUsage
        expr: cache_memory_bytes > 450000000
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: 'High cache memory usage'
          description: 'Cache memory is {{ humanize $value }}B (threshold: 450MB)'

      - alert: CacheCriticalMemoryUsage
        expr: cache_memory_bytes > 480000000
        for: 2m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: 'Critical cache memory usage'
          description: 'Cache memory is {{ humanize $value }}B (max: 512MB)'

      - alert: SlowCacheOperations
        expr: |
          histogram_quantile(0.95, 
            rate(cache_operation_duration_seconds_bucket[5m])
          ) * 1000 > 50
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: 'Slow cache operations'
          description: 'P95 cache operation time is {{ $value }}ms (threshold: 50ms)'

  # ============================================================================
  # System Resource Alerts
  # ============================================================================
  - name: system_resources
    interval: 30s
    rules:
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes > 1000000000
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: 'High memory usage'
          description: 'Memory usage is {{ humanize $value }}B (threshold: 1GB)'

      - alert: CriticalMemoryUsage
        expr: process_resident_memory_bytes > 1500000000
        for: 2m
        labels:
          severity: critical
          component: system
        annotations:
          summary: 'Critical memory usage'
          description: 'Memory usage is {{ humanize $value }}B (threshold: 1.5GB)'

      - alert: HighHeapUsage
        expr: nodejs_heap_size_used_bytes > 800000000
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: 'High Node.js heap usage'
          description: 'Heap usage is {{ humanize $value }}B (threshold: 800MB)'

  # ============================================================================
  # Business Logic Alerts
  # ============================================================================
  - name: business_metrics
    interval: 60s
    rules:
      - alert: NoRecentActivity
        expr: sum(rate(user_actions_total[5m])) == 0
        for: 15m
        labels:
          severity: warning
          component: business
        annotations:
          summary: 'No recent user activity detected'
          description: 'No user actions recorded in the last 15 minutes'

      - alert: SuspiciousActivitySpike
        expr: |
          sum(rate(user_actions_total[5m])) 
          > 
          avg_over_time(sum(rate(user_actions_total[5m]))[1h:5m]) * 5
        for: 5m
        labels:
          severity: warning
          component: business
        annotations:
          summary: 'Suspicious activity spike detected'
          description: 'User activity is {{ $value }}x above normal'

  # ============================================================================
  # Health Check Alerts
  # ============================================================================
  - name: health_checks
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job="firma-api"} == 0
        for: 1m
        labels:
          severity: critical
          component: health
        annotations:
          summary: 'Service is down'
          description: 'Firma API service is not responding'

      - alert: DatabaseUnhealthy
        expr: health_check_status{check="database"} == 0
        for: 2m
        labels:
          severity: critical
          component: health
        annotations:
          summary: 'Database health check failed'
          description: 'Database is not accessible or unhealthy'

      - alert: RedisUnhealthy
        expr: health_check_status{check="redis"} == 0
        for: 2m
        labels:
          severity: critical
          component: health
        annotations:
          summary: 'Redis health check failed'
          description: 'Redis is not accessible or unhealthy'

  # ============================================================================
  # Security Alerts
  # ============================================================================
  - name: security_alerts
    interval: 30s
    rules:
      - alert: HighAuthFailureRate
        expr: |
          sum(rate(http_requests_total{route=~".*auth.*",status_code="401"}[5m])) > 5
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: 'High authentication failure rate'
          description: '{{ $value }} auth failures/sec detected (possible attack)'

      - alert: TooMany4xxErrors
        expr: |
          sum(rate(http_requests_total{status_code=~"4.."}[5m])) 
          / sum(rate(http_requests_total[5m])) * 100 > 30
        for: 10m
        labels:
          severity: warning
          component: security
        annotations:
          summary: 'High client error rate'
          description: '{{ $value }}% of requests are client errors'
